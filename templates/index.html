<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>나침반(Compass)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=7.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/compass.css') }}?v=7.0">
</head>

<body>

    <div class="app-wrap" id="homeScreen">

        <!-- 헤더 (사용자 제공) -->
        <header class="header">
            <div class="header-icon" onclick="resetSystem()">☰</div>
            <div class="header-center">
                <div class="sub">당신의 영혼을 위한 나침반</div>
                <div class="title">COMPASS</div>
            </div>
            <div class="header-icon" onclick="resetSystem()">⚙️</div>
        </header>

        <!-- 메인 콘텐츠 -->
        <div class="main-content" style="padding-bottom: 120px;">
            <!-- ══ 나침반 섹션 (V4.5 모듈화) ══ -->
            <div class="compass-section">
                <div class="compass-wrapper">
                    <div class="compass-ring"></div>
                    <div class="compass-body" id="compassBody">
                        <svg class="compass-svg" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="gd1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#f0e6b0" />
                                    <stop offset="30%" stop-color="#c9a84c" />
                                    <stop offset="70%" stop-color="#b8943f" />
                                    <stop offset="100%" stop-color="#8a7030" />
                                </linearGradient>
                                <linearGradient id="ringG" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#d4b85c" stop-opacity="0.5" />
                                    <stop offset="50%" stop-color="#a8893a" stop-opacity="0.25" />
                                    <stop offset="100%" stop-color="#d4b85c" stop-opacity="0.5" />
                                </linearGradient>
                                <linearGradient id="nN" x1="0.5" y1="1" x2="0.5" y2="0">
                                    <stop offset="0%" stop-color="#c9a84c" />
                                    <stop offset="40%" stop-color="#d45040" />
                                    <stop offset="100%" stop-color="#e86050" />
                                </linearGradient>
                                <linearGradient id="nS" x1="0.5" y1="0" x2="0.5" y2="1">
                                    <stop offset="0%" stop-color="#a89060" />
                                    <stop offset="100%" stop-color="#504530" />
                                </linearGradient>
                                <linearGradient id="nE" x1="0" y1="0.5" x2="1" y2="0.5">
                                    <stop offset="0%" stop-color="#a89060" />
                                    <stop offset="100%" stop-color="#706040" />
                                </linearGradient>
                                <linearGradient id="nW" x1="1" y1="0.5" x2="0" y2="0.5">
                                    <stop offset="0%" stop-color="#a89060" />
                                    <stop offset="100%" stop-color="#706040" />
                                </linearGradient>
                                <radialGradient id="bgGlow" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" stop-color="rgba(201,168,76,0.07)" />
                                    <stop offset="100%" stop-color="rgba(201,168,76,0)" />
                                </radialGradient>
                                <radialGradient id="centerG" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" stop-color="rgba(201,168,76,0.2)" />
                                    <stop offset="60%" stop-color="rgba(201,168,76,0.04)" />
                                    <stop offset="100%" stop-color="rgba(201,168,76,0)" />
                                </radialGradient>
                            </defs>

                            <circle cx="200" cy="200" r="195" fill="url(#bgGlow)" />
                            <circle cx="200" cy="200" r="185" fill="none" stroke="url(#ringG)" stroke-width="1.5" />
                            <circle cx="200" cy="200" r="180" fill="none" stroke="url(#gd1)" stroke-width="0.6"
                                opacity="0.2" />
                            <circle cx="200" cy="200" r="170" fill="none" stroke="url(#gd1)" stroke-width="0.3"
                                opacity="0.1" />

                            <g id="compassTicks"></g>
                            <g id="compassDegLabels"></g>

                            <circle cx="200" cy="200" r="130" fill="none" stroke="url(#gd1)" stroke-width="0.4"
                                opacity="0.08" stroke-dasharray="2,5" />
                            <circle cx="200" cy="200" r="95" fill="none" stroke="url(#gd1)" stroke-width="0.2"
                                opacity="0.06" />

                            <line x1="200" y1="28" x2="200" y2="58" stroke="url(#gd1)" stroke-width="0.4"
                                opacity="0.15" />
                            <line x1="200" y1="342" x2="200" y2="372" stroke="url(#gd1)" stroke-width="0.4"
                                opacity="0.15" />
                            <line x1="28" y1="200" x2="58" y2="200" stroke="url(#gd1)" stroke-width="0.4"
                                opacity="0.15" />
                            <line x1="342" y1="200" x2="372" y2="200" stroke="url(#gd1)" stroke-width="0.4"
                                opacity="0.15" />

                            <g style="animation: crossPulse 3s ease-in-out infinite;">
                                <line x1="200" y1="20" x2="200" y2="44" stroke="#e86050" stroke-width="2.5"
                                    stroke-linecap="round" />
                                <line x1="191" y1="30" x2="209" y2="30" stroke="#e86050" stroke-width="2"
                                    stroke-linecap="round" />
                            </g>

                            <text x="355" y="205" text-anchor="middle" fill="url(#gd1)" font-size="15" font-weight="600"
                                opacity="0.65">E</text>
                            <text x="200" y="370" text-anchor="middle" fill="url(#gd1)" font-size="15" font-weight="600"
                                opacity="0.65">S</text>
                            <text x="45" y="205" text-anchor="middle" fill="url(#gd1)" font-size="15" font-weight="600"
                                opacity="0.65">W</text>

                            <text x="305" y="95" text-anchor="middle" fill="url(#gd1)" font-size="8"
                                opacity="0.22">NE</text>
                            <text x="305" y="315" text-anchor="middle" fill="url(#gd1)" font-size="8"
                                opacity="0.22">SE</text>
                            <text x="95" y="315" text-anchor="middle" fill="url(#gd1)" font-size="8"
                                opacity="0.22">SW</text>
                            <text x="95" y="95" text-anchor="middle" fill="url(#gd1)" font-size="8"
                                opacity="0.22">NW</text>

                            <polygon points="200,52 193,200 200,187 207,200" fill="url(#nN)" opacity="0.9" />
                            <polygon points="200,348 207,200 200,213 193,200" fill="url(#nS)" opacity="0.5" />
                            <polygon points="348,200 200,193 213,200 200,207" fill="url(#nE)" opacity="0.4" />
                            <polygon points="52,200 200,207 187,200 200,193" fill="url(#nW)" opacity="0.4" />

                            <circle cx="200" cy="200" r="22" fill="url(#centerG)"
                                style="animation: centerGlow 4s ease-in-out infinite;" />
                            <circle cx="200" cy="200" r="14" fill="#0a0e1a" stroke="url(#gd1)" stroke-width="2" />
                            <circle cx="200" cy="200" r="5" fill="url(#gd1)" opacity="0.75" />
                        </svg>
                    </div>
                </div>

                <!-- 방위 정보 -->
                <div class="compass-info">
                    <div class="degree-display" id="degreeDisplay">0<span>°</span></div>
                    <div class="direction-text" id="directionText">북쪽을 향하고 있습니다</div>
                </div>
                <div class="compass-status active" id="compassStatus">나침반 활성</div>
                <button class="compass-permission-btn" id="compassPermBtn" onclick="requestCompassPermission()">나침반 권한
                    허용</button>
            </div>

            <!-- AI 배지 및 인사말 -->
            <div class="ai-badge-text">
                🤖 김성수 목사님의 설교를 학습한 AI가 함께합니다<br>
                🔒 모든 대화는 기기 내 암호화 저장
            </div>

            <div class="greeting-area">
                <div class="hello">평안하십니까, <strong id="greetingName">반갑습니다</strong></div>
                <div class="sub-msg">나침반이 당신의 영적 여정을 기억합니다</div>
            </div>

            <!-- 기능 그리드 -->
            <div class="feature-grid">
                <div class="feature-card" onclick="handleClick('/search')">
                    <div class="icon">📖</div>
                    <div class="label">말씀 찾기</div>
                    <div class="desc">설교·성경 구절 검색</div>
                </div>
                <div class="feature-card" onclick="handleClick('/prayer')">
                    <div class="icon">🙏</div>
                    <div class="label">기도문</div>
                    <div class="desc">상황에 맞는 기도문 생성</div>
                </div>
                <div class="feature-card" onclick="handleClick('/devotion')">
                    <div class="icon">✨</div>
                    <div class="label">오늘의 묵상</div>
                    <div class="desc">오늘의 말씀과 묵상 가이드</div>
                </div>
                <div class="feature-card" onclick="handleClick('/chat')">
                    <div class="icon">💬</div>
                    <div class="label">목사님 말씀 상담</div>
                    <div class="desc">AI 영적 상담 대화</div>
                </div>
            </div>

            <!-- 하단 입력바 (사용자 제공 V4.0 정식 기능화) -->
            <div class="bottom-bar">
                <div class="input-wrap" style="flex-direction: column; align-items: center; padding: 12px 15px;">
                    <div style="display: flex; align-items: center; width: 100%;">
                        <button class="mic-btn" onclick="startVoice(this)">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path
                                    d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                <path
                                    d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                            </svg>
                        </button>
                        <input type="text" id="chatInput" placeholder="고민이나 상황을 말씀해주세요..."
                            onkeypress="if(event.keyCode==13) sendMessage()">
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">➤</button>
                    </div>
                    <div class="mic-guide">마이크 터치 후 말씀하시고, 다시 한번 터치하세요</div>
                </div>
            </div>
        </div>

    </div>

    <!-- 채팅 오버레이 (대화 내용 표시용) -->
    <div class="modal-overlay" id="chatOverlay" style="z-index: 1000;">
        <div class="modal-content"
            style="max-width: 420px; height: 85vh; display: flex; flex-direction: column; padding: 0; background: #0f1526;">
            <div class="modal-header"
                style="padding: 18px 20px; border-bottom: 1px solid rgba(201,168,76,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(201,168,76,0.03);">
                <h3 style="color: #c9a84c; font-size: 16px; margin: 0; display: flex; align-items: center; gap: 8px;">
                    <span id="chatIcon">💬</span> <span id="chatTitle">AI 목사님 상담</span>
                </h3>
                <button class="chat-close" onclick="closeModal('chatOverlay')"
                    style="background: none; border: none; color: #c9a84c; font-size: 20px; cursor: pointer; padding: 5px;">✕</button>
            </div>

            <div id="chatMessages"
                style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 18px; scroll-behavior: smooth;">
                <!-- 메시지가 여기에 추가됨 -->
            </div>

            <!-- AI 묵상중 표시 (스피너) -->
            <div id="meditating"
                style="display: none; padding: 15px 20px; align-items: center; gap: 12px; background: rgba(201,168,76,0.02);">
                <div class="spinner"></div>
                <span style="font-size: 13px; color: #c9a84c; opacity: 0.8;">목사님이 묵상 중입니다...</span>
            </div>

            <div style="padding: 12px 20px; border-top: 1px solid rgba(201,168,76,0.1); background: #0a0e1a;">
                <div class="input-wrap"
                    style="background: rgba(255,255,255,0.04); border-radius: 20px; flex-direction: column; align-items: center; padding: 12px 15px;">
                    <div style="display: flex; align-items: center; width: 100%;">
                        <button class="mic-btn modal-mic" onclick="startVoice(this, 'modal')">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path
                                    d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                <path
                                    d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                            </svg>
                        </button>
                        <input type="text" id="modalChatInput" placeholder="목사님께 궁금한 점을 입력하세요..."
                            onkeypress="if(event.keyCode==13) sendMessage('modal')" style="height: 34px;">
                        <button class="send-btn" onclick="sendMessage('modal')"
                            style="background: #c9a84c; color: #0a0e1a; width: 30px; height: 30px; border-radius: 50%; padding: 0;">➤</button>
                    </div>
                    <div class="mic-guide">마이크 터치 후 말씀하시고, 다시 한번 터치하세요</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 등록 안내 팝업 -->
    <div class="overlay" id="registerOverlay">
        <div class="register-popup">
            <div class="popup-icon">🧭</div>
            <h3>서비스 이용을 위해<br>간단한 등록이 필요합니다</h3>
            <p>맞춤형 영적 상담을 위해<br>기본 정보와 약관 동의가 필요합니다.<br>1분이면 완료됩니다.</p>
            <button class="btn-register" onclick="showRegisterScreen()">등록하고 시작하기</button>
            <button class="btn-cancel" onclick="closeRegisterOverlay()">돌아가기</button>
        </div>
    </div>

    <!-- 등록 화면 (인라인) -->
    <div class="register-screen" id="registerScreen">
        <div class="register-container">

            <div class="reg-logo-area">
                <div class="reg-logo-icon">🧭</div>
                <div class="reg-greeting">할렐루야 !</div>
                <div class="reg-service-name">
                    <strong>'나침반(Compass)'</strong>은 김성수 목사님의 강해를 통해<br>
                    귀하의 영적 고민을 함께 나누는 길잡이입니다.
                </div>
            </div>

            <div class="reg-ai-notice">
                <p>🤖 본 서비스는 김성수 목사님의 설교 자료를 학습한 <strong>AI(인공지능)</strong>가 응답합니다.<br>
                    실제 목사님이 직접 답변하시는 것이 아닙니다.</p>
            </div>

            <div class="reg-service-features">
                24시간 신앙 상담 · 설교 말씀 검색 · 성경 질문이 가능합니다
            </div>

            <div class="reg-section-title">기본 설정</div>
            <div class="reg-section-desc">
                귀하께 더 깊이 있는 답변을 드리기 위해<br>
                최소한의 정보만 활용됩니다.
            </div>

            <div class="form-group">
                <label class="form-label">성함 (닉네임)</label>
                <input type="text" class="form-input" id="userName" placeholder="예: 홍길동 또는 은혜성도">
            </div>

            <div class="form-group">
                <label class="form-label">연령대 및 성별</label>
                <div class="form-row">
                    <div class="form-select-wrap">
                        <select class="form-select" id="userAge">
                            <option value="">연령대</option>
                            <option value="10s">10대 이하</option>
                            <option value="20s">20대</option>
                            <option value="30s">30대</option>
                            <option value="40s">40대</option>
                            <option value="50s">50대</option>
                            <option value="60s">60대</option>
                            <option value="70s">70대 이상</option>
                        </select>
                    </div>
                    <div class="form-select-wrap">
                        <select class="form-select" id="userGender">
                            <option value="">성별</option>
                            <option value="male">남성</option>
                            <option value="female">여성</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">거주 지역 <span class="optional">(선택)</span></label>
                <select class="form-select" id="userRegion">
                    <option value="">선택해 주세요</option>
                    <option value="seoul">서울</option>
                    <option value="gyeonggi">경기</option>
                    <option value="incheon">인천</option>
                    <option value="busan">부산</option>
                    <option value="daegu">대구</option>
                    <option value="daejeon">대전</option>
                    <option value="gwangju">광주</option>
                    <option value="ulsan">울산</option>
                    <option value="sejong">세종</option>
                    <option value="gangwon">강원</option>
                    <option value="chungbuk">충북</option>
                    <option value="chungnam">충남</option>
                    <option value="jeonbuk">전북</option>
                    <option value="jeonnam">전남</option>
                    <option value="gyeongbuk">경북</option>
                    <option value="gyeongnam">경남</option>
                    <option value="jeju">제주</option>
                    <option value="overseas">해외</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">직업 <span class="optional">(선택)</span></label>
                <select class="form-select" id="userJob">
                    <option value="">선택해 주세요</option>
                    <option value="student">학생</option>
                    <option value="office">직장인</option>
                    <option value="self">자영업</option>
                    <option value="professional">전문직</option>
                    <option value="homemaker">주부</option>
                    <option value="retired">은퇴</option>
                    <option value="pastor">사역자/전도사</option>
                    <option value="other">기타</option>
                </select>
            </div>

            <div class="terms-area">
                <div class="terms-check">
                    <input type="checkbox" id="agreeAll" onchange="toggleAll(this)">
                    <label for="agreeAll"><strong>전체 동의</strong></label>
                </div>
                <div class="terms-check">
                    <input type="checkbox" id="agreeTerms" class="agree-item" onchange="checkAll()">
                    <label for="agreeTerms"><a href="#" onclick="openModal('termsModal'); return false;">서비스 이용약관</a>에
                        동의합니다 (필수)</label>
                </div>
                <div class="terms-check">
                    <input type="checkbox" id="agreePrivacy" class="agree-item" onchange="checkAll()">
                    <label for="agreePrivacy"><a href="#"
                            onclick="openModal('privacyModal'); return false;">개인정보처리방침</a>에 동의합니다 (필수)</label>
                </div>
                <div class="terms-check">
                    <input type="checkbox" id="agreeAI" class="agree-item" onchange="checkAll()">
                    <label for="agreeAI"><a href="#" onclick="openModal('aiModal'); return false;">AI 서비스 안내</a>를 확인했습니다
                        (필수)</label>
                </div>
            </div>

            <button class="btn-primary" id="startBtn" disabled onclick="completeRegistration()">
                정보 저장하고 시작하기
            </button>

            <div class="privacy-notice">
                <div class="privacy-icon">🔒</div>
                <p>프라이버시 보호 안내<br>
                    모든 대화는 외부 서버에 저장되지 않으며,<br>
                    귀하의 기기에만 안전하게 암호화되어 보관됩니다.</p>
            </div>

        </div>
    </div>

    <!-- 모달: 이용약관 -->
    <div class="modal-overlay" id="termsModal">
        <div class="modal-content" id="termsContent"></div>
    </div>

    <!-- 모달: 개인정보처리방침 -->
    <div class="modal-overlay" id="privacyModal">
        <div class="modal-content" id="privacyContent"></div>
    </div>

    <!-- 모달: AI 서비스 안내 -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal-content" id="aiContent"></div>
    </div>

    <script src="{{ url_for('static', filename='js/compass.js') }}?v=8.0"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v=8.0"></script>
    <script>
        // 모달 콘텐츠 로드 (Flask 라우트 호출)
        fetch('/terms').then(r => r.text()).then(html => {
            document.getElementById('termsContent').innerHTML = html;
        });
        fetch('/privacy').then(r => r.text()).then(html => {
            document.getElementById('privacyContent').innerHTML = html;
        });
        fetch('/ai-notice').then(r => r.text()).then(html => {
            document.getElementById('aiContent').innerHTML = html;
        });
    </script>

</body>

</html>